

# XMUAssistantBot

**XMUAssistantBot** 是一款专为 **厦门大学转专业交流群** 定制的高性能自动化管理机器人。它基于 Rust 异步生态，通过自研消息路由与分层存储架构，在处理 2000 人规模高并发群聊场景下，实现了极致的 I/O 效率与低内存分配。

------

## ⚡ 性能基准 (Performance Benchmark)

基于项目内 `benches/` 模块的实测数据（环境：Linux x64, Release Mode）：

### 1. 消息路由与分发 (ABI Efficiency)

- **轻量化 Context 克隆**: `41.39 ns` — 24 字节极致精简结构，支持瞬时拉起数千个异步 Handler。
- **Context 重负载克隆 (带8条消息)**: `1.99 µs` — 即使在消息处理中后期，克隆开销依然极低。
- **并发 Handler 分发 (x10)**: `20.10 µs` — 模拟 10 个 Handler 同时并行运行的系统级开销。

### 2. 极致的正则与匹配优化

- **自研快速匹配**: 相比标准正则表达式，项目实现的快速匹配逻辑达到了 **67x ~ 110x** 的加速。
  - **传统正则耗时**: `3.51 ms`
  - **快速匹配耗时**: `31.7 µs`

### 3. 存储与序列化性能

- **并发存储吞吐**: `51.58 µs` (100路并发读写) — 完美承载高频会话校验。
- **序列化流水线**: `1.68 µs` — 在 **MiMalloc** 支持下的全流程 JSON 解析与构造。

------

## 🛠️ 深度技术优化 (Technical Deep Dive)

### 1. 极致的内存分配策略

- **MiMalloc 全局分配器**: 放弃系统默认分配器，采用 `MiMalloc` 优化瞬时大量 JSON 对象的分配，极大降低内存碎片率和全局锁竞争。
- **栈空间优先与零分配**:
  - 大量使用 `smol_str` 存储短字符串，通过 Inline 优化避免堆分配。
  - 在序列化流水线中使用 `serde_json::to_writer` 配合预分配缓冲区，实现“零分配”数据流转。

### 2. 异步 I/O 与分层存储架构

项目实现了 **Hot-Cold-File** 语义化分层存储系统：

- **Hot 层 (DashMap)**: 存储当前活跃的会话（`LoginData`），读写复杂度 $O(1)$。
- **Cold 层 (Redb)**: 采用 Copy-on-Write (CoW) 机制的嵌入式数据库，通过异步 Task 批量提交事务，完全剥离主循环 I/O。
- **RAII 临时文件管理**: 自研 `TempFile` 系统，利用 `Drop` 钩子自动触发异步清理，确保存储空间整洁。

### 3. 基于过程宏的元编程

- **`#[handler]`**: 自动处理命令过滤、异步 Context 转换及统一异常屏障（Error Boundary）。
- **`#[jw_api]`**: 专为厦大教务系统定制，自动化封装 `CASTGC` 会话维持与非标 JSON 的健壮解析。

### 4. Expose 模块：带上下文的文件暴露

- **流式下载**: 基于 `axum` 的 `ReaderStream` 实现从磁盘到浏览器的零拷贝直传。
- **语义化缓存**: 缓存文件路径映射与路由哈希，多用户请求同一资源时 O(1) 命中，无需重复扫描磁盘。

------

## 🤖 指令概览 (Commands)

| **指令**        | **逻辑流**              | **优化亮点**                        |
| --------------- | ----------------------- | ----------------------------------- |
| **`/login`**    | 身份认证 -> 持久化      | 自动维护教务会话，多端登录不冲突    |
| **`/download`** | 触发 Expose -> 返回链接 | 异步 Flush 确保生成链接前文件已落盘 |
| **`/logout`**   | 缓存注销 -> 状态回滚    | $O(1)$ 时间复杂度快速清理热数据     |
| **`/echo`**     | 消息回传                | 用于端到端延迟测试                  |

------

## 📁 项目结构 (Project Structure)

Plaintext

```
├── src/abi/        # 自研 ABI 层：包含路由、消息体解析与网络适配
├── src/api/        # 核心业务接口：存储(Storage)、教务服务(XMU Service)、LLM
├── src/logic/      # 业务逻辑实现：登录流程、下载处理
├── src/web/        # Web 服务：Expose 文件暴露系统
└── benches/        # 性能基准测试：压榨每一纳秒的运行效率
```

------

## 🤝 参与贡献 (Contributing)

我们非常欢迎来自厦大或其他高校的开发者提交 PR！

- **优化 API 定义**: 如果你发现了教务系统（Jw）的新接口，欢迎补充 `#[jw_api]` 定义。
- **改进 Web 视图**: 期待你对 `Expose` 模块 HTML 界面的 UI/UX 优化。
- **性能提升**: 欢迎针对 `benches/` 中的指标提交更优的算法实现。

**提交规范**:

1. 代码必须通过 `cargo fmt` 格式化。
2. 高性能模块的修改请附带 `cargo bench` 结果对比。

